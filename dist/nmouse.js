/*
 * Nostradamouse 0.1.5
 * Copyright (c) 2015 Sepand Parhami
 * Licensed under the MIT license
 */

!function(a,b){function c(a){this.storage=a}b.nmouse=a;var d=function(){var a=Array.prototype.slice;return{flatMap:function(a,b){return a.reduce(function(a,c){return a.concat(b(c))},[])},mix:function(a,b){return Object.keys(b).forEach(function(c){a[c]=b[c]}),a},extend:function(a,b,c){a.prototype=this.mix(Object.create(b.prototype),c||{}),a.prototype.constructor=a},getAncestry:function b(a){return a?[a].concat(b(a.parentNode)):[]},getDescendants:function c(b){var e=a.call(b.children||[]);return d.flatMap(e,c).concat(b)}}}(),e=function(a,b,c){this.evtName=a,this.loader=b,this.root=c,this.triggers=[]};e.prototype={setupListener:function(){var a=!!this.triggers.length;this.root[a?"addEventListener":"removeEventListener"](this.evtName,this,!0)},getTrippedTriggers:function(a){return d.getAncestry(a.target).filter(function(a){return a.matches}).map(function(a){return this.triggers.filter(function(b){return a.matches(b.selector)})}.bind(this)).reduce(function(a,b){return a.concat(b)},[])},handleEvent:function(a){a.target!==window&&(this.getTrippedTriggers(a).forEach(function(a){this.loader.load(a.src),a.tripped=!0}.bind(this)),this.triggers=this.triggers.filter(function(a){return!a.tripped}),this.setupListener())},addTrigger:function(a){this.triggers.push(a),this.setupListener()}};var f=function(a,b){e.call(this,"mousemove",a,b)};d.extend(f,e,{isNear:function(a,b,c){var d=(a.left+a.right)/2,e=(a.top+a.bottom)/2,f=Math.abs(b.x-d)-a.width/2,g=Math.abs(b.y-e)-a.height/2;return c>=f&&c>=g},getTrippedTriggers:function(a){var b={x:a.clientX,y:a.clientY};return this.triggers.filter(function(a){return this.isNear(a.el.getBoundingClientRect(),b,a.distance)}.bind(this))}});var g=function(a,b){this.loader=a,this.root=b,this.triggers={},this.observer=new MutationObserver(this.observe.bind(this))};g.prototype={setupObserver:function(){var a=!!Object.keys(this.triggers).length,b=this.observer;a?b.observe(document,{childList:!0,subtree:!0}):b.disconnect()},observe:function(a){var b=this.loader,c=this.triggers;a.forEach(function(a){var e=[].slice.call(a.addedNodes);d.flatMap(e,d.getDescendants).forEach(function(a){var d=c[a.tagName];d&&(b.load(d.src),delete c[a.tagName])})}),this.setupObserver()},addTrigger:function(a){document.getElementsByTagName(a.tagName).length?this.loader.load(a.src):(this.triggers[a.tagName.toUpperCase()]=a,this.setupObserver())}};var h=function(a,b){this.loader=a,this.root=b};h.prototype={addTrigger:function(a){var b=this.loader,c=a.el,d=a.src,e=document.createElement("div"),f=e.style;f.position="absolute",f.top=0,f.right=0,f.left=0,f.bottom=0,f.margin="-"+a.distance+"px",e.className="nmouse-tripwire",e.addEventListener("mouseover",function(){b.load(d),c.removeChild(e)}),c.appendChild(e)}};var i=function(){this.loadedDefs={}};i.prototype={get:function(a){return this.loadedDefs[a]},load:function(a){return this.loadedDefs[a]||(this.loadedDefs[a]=new Promise(function(b,c){var d=document.querySelector("head"),e=document.createElement("link");e.href=a,e.rel="import",e.onload=function(){b(e)},e.onerror=function(){console.error("Failed to load resource "+a),c()},d.appendChild(e)})),this.loadedDefs[a]}},c.prototype={getKey:function(a){return"nmouse-"+a},getDeps:function(a){var b=this.getKey(a);return JSON.parse(this.storage.getItem(b))||[]},setDeps:function(a,b){var c=this.getKey(a);this.storage.setItem(c,JSON.stringify(b))}};var j=function(a){this.loader=new i,this.originRegExp=new RegExp("^"+location.origin),this.depsStorage=a};j.prototype={load:function(a){var b,c=this.loader;return c.get(a)?c.get(a):(b=c.load(a).then(function(b){return this.updateDeps(a,b.import),b}.bind(this)),this.loadDeps(a),b)},getNormalizedHref:function(a){return a.replace(this.originRegExp,"")},updateDeps:function(a,b){var c=[].slice.call(b.querySelectorAll('link[rel="import"]')),d=c.map(function(a){return this.getNormalizedHref(a.href)}.bind(this));this.depsStorage.setDeps(a,d),d.forEach(function(a){this.load(a)}.bind(this))},loadDeps:function(a){var b=this.depsStorage.getDeps(a);b.forEach(function(a){this.load(a)}.bind(this))}},function(){function a(a,b){var c=b||document.body;a.triggers.forEach(function(b){i(b,a,c)})}function b(a,b){switch(a){case"added":return new g(k,b);case"proximity":return new m(k,b);case"node-proximity":return new h(k,b);case"mousemove-proximity":return new f(k,b);default:return new e(a,k,b)}}function d(a,c){return l.get(c)||l.set(c,{}),l.get(c)[a]||(l.get(c)[a]=b(a,c)),l.get(c)[a]}function i(a,b,c){var e=b.el;d(a.type,c).addTrigger({el:"string"==typeof e?c.querySelector(e):e,selector:b.selector,src:b.src,tagName:a.tagName,distance:a.distance})}var k=new j(new c(localStorage)),l=new WeakMap,m=function(a,b){this.root=b};m.prototype.addTrigger=function(a){var b=getComputedStyle(a.el);"visible"!==b.overflow||"static"===b.position?d("mousemove-proximity",this.root).addTrigger(a):d("node-proximity",this.root).addTrigger(a)},window.nmouse={prepare:a,loader:k}}(),document.registerElement("nmouse-rule",{prototype:d.mix(Object.create(HTMLElement.prototype),{attachedCallback:function(){var a=[].slice.call(this.querySelectorAll("nmouse-trigger")).map(function(a){return{type:a.getAttribute("type"),tagName:a.getAttribute("tagName"),distance:a.getAttribute("distance")}}),b=d.getAncestry(this);nmouse.prepare({el:this.getAttribute("el"),selector:this.getAttribute("selector"),src:this.getAttribute("src"),triggers:a},b[b.length-1])}})})}({},function(){return this}());
//# sourceMappingURL=nmouse.js.map