{"version":3,"file":"nmouse.js","sources":["../src/defs.js","../src/dependencies/DepsStorage.js","../src/Utils.js","../src/handlers/DelegatedEventHandler.js","../src/handlers/MouseMoveProximityHandler.js","../src/handlers/NodeAddedHandler.js","../src/handlers/NodeProximityHandler.js","../src/Loader.js","../src/dependencies/DepsTrackingLoader.js","../src/nmouse.js","../src/CustomElementApi.js"],"names":[],"mappings":"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","sourcesContent":["if(typeof DEBUG === 'undefined') {\n    DEBUG = true;\n}\n","// TODO - expire caching based on date, size limitations\n// -> keep track of keys that we add so that we can clear individual keys as needed\n// -> [ { key, timeLastUsed }, ... ]\n\nfunction DepsStorage(storage) {\n    this.storage = storage;\n}\n\nDepsStorage.prototype = {\n    getKey: function(src) {\n        return 'nmouse-' + src;\n    },\n\n    getDeps: function(src) {\n        var key = this.getKey(src);\n\n        return JSON.parse(this.storage.getItem(key)) || [];\n    },\n\n    setDeps: function(src, deps) {\n        var key = this.getKey(src);\n\n        this.storage.setItem(key, JSON.stringify(deps));\n    }\n};\n","var Utils = (function() {\n    var slice = Array.prototype.slice;\n\n    return {\n        flatMap: function(items, fn) {\n            return items.reduce(function(p, c) {\n                return p.concat(fn(c));\n            }, []);\n        },\n\n        mix: function(dest, src) {\n            Object.keys(src).forEach(function(key) {\n                dest[key] = src[key];\n            });\n\n            return dest;\n        },\n\n        extend: function(child, parent, protoFunctions) {\n            child.prototype = this.mix(Object.create(parent.prototype), protoFunctions || {});\n            child.prototype.constructor = child;\n        },\n\n        getNode: function(thing) {\n            if(typeof thing === 'string') {\n                return document.querySelector(thing);\n            } else if(thing instanceof HTMLElement) {\n                return thing;\n            }\n\n            if(DEBUG) {\n                throw Error('invalid thing specified');\n            }\n        },\n\n        getAncestry: function _utilsGetAncestry(node) {\n            return node ? [node].concat(_utilsGetAncestry(node.parentElement)) : [];\n        },\n\n        getDescendants: function _utilsGetDescendants(node) {\n            var children = slice.call(node.children || []);\n\n            return Utils\n                .flatMap(children, _utilsGetDescendants)\n                .concat(node);\n        }\n    };\n})();\n","var DelegatedEventHandler = function(evtName, loader) {\n    this.evtName = evtName;\n    this.loader = loader;\n    this.triggers = [];\n};\n\nDelegatedEventHandler.prototype = {\n    setupListener: function() {\n        var haveTriggers = !!this.triggers.length;\n\n        window[haveTriggers ? 'addEventListener' : 'removeEventListener'](this.evtName, this, true);\n    },\n\n    getTrippedTriggers: function(e) {\n        return Utils.getAncestry(e.target)\n        .map(function(node) {\n            return this.triggers.filter(function(trigger) {\n                return node.matches(trigger.selector);\n            });\n        }.bind(this))\n        .reduce(function(p, c) {\n            return p.concat(c);\n        }, []);\n    },\n\n    handleEvent: function(e) {\n        if(e.target === window) {\n            return;\n        }\n\n        this.getTrippedTriggers(e)\n        .forEach(function(trigger) {\n            this.loader.load(trigger.src);\n            trigger.tripped = true;\n        }.bind(this));\n\n        this.triggers = this.triggers\n        .filter(function(trigger) {\n            return !trigger.tripped;\n        });\n\n        this.setupListener();\n    },\n\n    addTrigger: function(params) {\n        this.triggers.push(params);\n        this.setupListener();\n    }\n};\n","var MouseMoveProximityHandler = function(loader) {\n    DelegatedEventHandler.call(this, 'mousemove', loader);\n};\n\nUtils.extend(MouseMoveProximityHandler, DelegatedEventHandler, {\n    isNear: function(rect, coords, distance) {\n        var x = (rect.left + rect.right) / 2,\n            y = (rect.top + rect.bottom) / 2,\n            dx = Math.abs(coords.x - x) - (rect.width / 2),\n            dy = Math.abs(coords.y - y) - (rect.height / 2);\n\n        return dx <= distance && dy <= distance;\n    },\n\n    getTrippedTriggers: function(e) {\n        var coords = {\n                x: e.clientX,\n                y: e.clientY\n            };\n\n        return this.triggers\n        .filter(function(trigger) {\n            return this.isNear(trigger.el.getBoundingClientRect(), coords, trigger.distance);\n        }.bind(this));\n    }\n});\n","var NodeAddedHandler = function(loader) {\n    this.loader = loader;\n    this.triggers = {};\n    this.observer = new MutationObserver(this.observe.bind(this));\n};\n\nNodeAddedHandler.prototype = {\n    setupObserver: function() {\n        var haveTriggers = !!Object.keys(this.triggers).length,\n            observer = this.observer;\n\n        if(haveTriggers) {\n            observer.observe(document, { childList: true, subtree: true });\n        } else {\n            observer.disconnect();\n        }\n    },\n\n    observe: function(mutations) {\n        var loader = this.loader,\n            triggers = this.triggers;\n\n        mutations.forEach(function(mutation) {\n            var addedNodes = [].slice.call(mutation.addedNodes);\n\n            Utils\n                .flatMap(addedNodes, Utils.getDescendants)\n                .forEach(function(node) {\n                    var trigger = triggers[node.tagName];\n\n                    if(trigger) {\n                        loader.load(trigger.src);\n                        delete triggers[node.tagName];\n                    }\n                });\n        });\n\n        this.setupObserver();\n    },\n\n    addTrigger: function(params) {\n        if(document.getElementsByTagName(params.tagName).length) {\n            this.loader.load(params.src);\n        } else {\n            // TODO - support one tagName mapping to multiple srcs\n            this.triggers[params.tagName.toUpperCase()] = params;\n            this.setupObserver();\n        }\n    }\n};\n","var NodeProximityHandler = function(loader) {\n    this.loader = loader;\n};\n\nNodeProximityHandler.prototype = {\n    addTrigger: function(params) {\n        var loader = this.loader,\n            el = params.el,\n            src = params.src,\n            tripwire = document.createElement('div'),\n            style = tripwire.style;\n\n        style.position = 'absolute';\n        style.top = 0;\n        style.right = 0;\n        style.left = 0;\n        style.bottom = 0;\n        style.margin = '-' + params.distance + 'px';\n\n        tripwire.className = 'nmouse-tripwire';\n        tripwire.addEventListener('mouseover', function() {\n            loader.load(src);\n            el.removeChild(tripwire);\n        });\n\n        el.appendChild(tripwire);\n    }\n};\n","var Loader = function() {\n    this.loadedDefs = {};\n};\n\nLoader.prototype = {\n    get: function(src) {\n        return this.loadedDefs[src];\n    },\n\n    load: function(src) {\n        if(!this.loadedDefs[src]) {\n            this.loadedDefs[src] = new Promise(function(resolve, reject) {\n                var head = document.querySelector('head'),\n                    link = document.createElement('link');\n\n                link.href = src;\n                link.rel = 'import';\n                link.onload = function() {\n                    resolve(link);\n                };\n                link.onerror = reject;\n                head.appendChild(link);\n            });\n        }\n\n        return this.loadedDefs[src];\n    }\n};\n","var DepsTrackingLoader = function(depsStorage) {\n    this.loader = new Loader();\n    this.depsStorage = depsStorage;\n};\n\nDepsTrackingLoader.prototype = {\n    load: function(src) {\n        var _this = this,\n            loader = this.loader,\n            promise;\n\n        if(loader.get(src)) {\n            return loader.get(src);\n        }\n\n        promise = loader.load(src)\n            .then(function(link) {\n                _this.updateDeps(src, link.import);\n\n                return link;\n            });\n\n        // Load deps afterwards so loading is blocked by max number of network\n        // connections being used to load deps for non-SPDY / HTTP/2 case\n        this.loadDeps(src);\n\n        return promise;\n    },\n\n    updateDeps: function(src, doc) {\n        var links = [].slice.call(doc.querySelectorAll('link[rel=\"import\"]')),\n            deps = links.map(function(link) {\n                return link.href;\n            });\n\n        this.depsStorage.setDeps(src, deps);\n        /*\n         * Try to load the dep just in case it has not been loaded by us before.\n         * This is to make sure we traverse down and capture the whole\n         * dependency tree on the first load of the page.\n         */\n        deps.forEach(function(dep) {\n            this.load(dep);\n        }.bind(this));\n    },\n\n    loadDeps: function(src) {\n        var deps = this.depsStorage.getDeps(src);\n\n        deps.forEach(function(dep) {\n            this.load(dep);\n        }.bind(this));\n    }\n};\n","(function() {\n    var loader = new DepsTrackingLoader(new DepsStorage(localStorage)),\n        handlers = {};\n\n    var proximityHandler = {\n        addTrigger: function(params) {\n            var style = getComputedStyle(params.el);\n\n            if(style.overflow !== 'visible' || style.position === 'static') {\n                if(DEBUG) {\n                    console.warn('Cannot create a simple trigger due to positioning or overflow, falling back to using mousemove.');\n                }\n                getHandler('mousemove-proximity').addTrigger(params);\n            } else {\n                getHandler('node-proximity').addTrigger(params);\n            }\n        }\n    };\n\n    function prepare(params) {\n        params.triggers.forEach(function(trigger) {\n            prepareTrigger(trigger, params);\n        });\n    }\n\n    function createHandler(type) {\n        switch(type) {\n            case 'added':\n                return new NodeAddedHandler(loader);\n            case 'proximity':\n                return proximityHandler;\n            case 'node-proximity':\n                return new NodeProximityHandler(loader);\n            case 'mousemove-proximity':\n                return new MouseMoveProximityHandler(loader);\n            default:\n                return new DelegatedEventHandler(type, loader);\n        }\n    }\n\n    function getHandler(type) {\n        if(!handlers[type]) {\n            handlers[type] = createHandler(type);\n        }\n\n        return handlers[type];\n    }\n\n    function prepareTrigger(trigger, params) {\n        getHandler(trigger.type).addTrigger({\n            el: Utils.getNode(params.el),\n            selector: params.selector,\n            src: params.src,\n            tagName: trigger.tagName,\n            distance: trigger.distance\n        });\n    }\n\n    window.nmouse = {\n        prepare: prepare,\n        loader: loader\n    };\n})();\n","/**\n * Custom Element bindings\n *\n * Example usage:\n * <code>\n *  <nmouse-rule\n *   el=\"#some .css > selector\"\n *   src=\"path/to/element/definition\">\n *   <nmouse-trigger\n *     type=\"proximity\"\n *     distance=\"100\">\n *   </nmouse-trigger>\n *   <nmouse-trigger type=\"focus\"></nmouse-trigger>\n *  </nmouse-rule>\n * </code>\n */\n(function() {\n    document.registerElement('nmouse-rule', {\n        prototype: Utils.mix(Object.create(HTMLElement.prototype), {\n            attachedCallback: function() {\n                var triggers = [].slice.call(this.querySelectorAll('nmouse-trigger'))\n                    .map(function(node) {\n                        return {\n                            type: node.getAttribute('type'),\n                            tagName: node.getAttribute('tagName'),\n                            distance: node.getAttribute('distance')\n                        };\n                    });\n\n                nmouse.prepare({\n                    el: this.getAttribute('el'),\n                    selector: this.getAttribute('selector'),\n                    src: this.getAttribute('src'),\n                    triggers: triggers\n                });\n            }\n        })\n    });\n})();\n"]}