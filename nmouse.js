/*
 * Nostradamouse - (c) 2014 Sepand Parhami
 * Licensed under the MIT license
 */

!function(a,b){function c(a){this.storage=a}b.nmouse=a;var d={mix:function(a,b){return Object.keys(b).forEach(function(c){a[c]=b[c]}),a},extend:function(a,b,c){a.prototype=this.mix(Object.create(b.prototype),c||{}),a.prototype.constructor=a},getNode:function(a){return"string"==typeof a?document.querySelector(a):a instanceof HTMLElement?a:void 0},getAncestry:function(a){var b,c=[];for(b=a;b;b=b.parentElement)b instanceof HTMLElement&&c.push(b);return c}},e=function(a,b){this.evtName=a,this.loader=b,this.triggers=[]};e.prototype={setupListener:function(){var a=!!this.triggers.length;window[a?"addEventListener":"removeEventListener"](this.evtName,this,!0)},getTrippedTriggers:function(a){return d.getAncestry(a.target).map(function(a){return this.triggers.filter(function(b){return a.matches(b.selector)})},this).reduce(function(a,b){return a.concat(b)},[])},handleEvent:function(a){this.getTrippedTriggers(a).forEach(function(a){this.loader.load(a.src),a.tripped=!0},this),this.triggers=this.triggers.filter(function(a){return!a.tripped}),this.setupListener()},addTrigger:function(a){this.triggers.push(a),this.setupListener()}};var f=function(a){e.call(this,"mousemove",a)};d.extend(f,e,{isNear:function(a,b,c){var d=(a.left+a.right)/2,e=(a.top+a.bottom)/2,f=Math.abs(b.x-d)-a.width/2,g=Math.abs(b.y-e)-a.height/2;return c>=f&&c>=g},getTrippedTriggers:function(a){var b={x:a.clientX,y:a.clientY};return this.triggers.filter(function(a){return this.isNear(a.el.getBoundingClientRect(),b,a.distance)},this)}});var g=function(a){this.loader=a,this.triggers={},this.observer=new MutationObserver(this.observe.bind(this))};g.prototype={setupObserver:function(){var a=!!Object.keys(this.triggers).length,b=this.observer;a?b.observe(document,{childList:!0,subtree:!0}):b.disconnect()},observe:function(a){a.forEach(function(a){for(var b=0;b<a.addedNodes.length;b++){var c=a.addedNodes[b],d=this.triggers[c.tagName];d&&(this.loader.load(d.src),delete this.triggers[c.tagName])}},this),this.setupObserver()},addTrigger:function(a){this.triggers[a.tagName.toUpperCase()]=a,this.setupObserver()}};var h=function(a){this.loader=a};h.prototype={addTrigger:function(a){var b=this,c=a.el,d=a.src,e=document.createElement("div"),f=e.style;f.position="absolute",f.top=0,f.right=0,f.left=0,f.bottom=0,f.margin="-"+a.distance+"px",e.className="nmouse-tripwire",e.addEventListener("mouseover",function(){b.loader.load(d),c.removeChild(e)}),c.appendChild(e)}};var i=function(){this.loadedDefs={}};i.prototype={get:function(a){return this.loadedDefs[a]},load:function(a,b){if(!this.get(a)){var c=document.querySelector("head"),d=document.createElement("link");d.href=a,d.rel="import",d.onload=b,c.appendChild(d),this.loadedDefs[a]=d}}},c.prototype={getKey:function(a){return"nmouse-"+a},getDeps:function(a){var b=this.getKey(a);return JSON.parse(this.storage.getItem(b))||[]},setDeps:function(a,b){var c=this.getKey(a);this.storage.setItem(c,JSON.stringify(b))}};var j=function(a){this.loader=new i,this.depsStorage=a};j.prototype={load:function(a,b){var c=this,d=this.loader;d.get(a)||(d.load(a,function(d){c.updateDeps(a,d.target.import),b&&b()}),this.loadDeps(a))},updateDeps:function(a,b){var c=[].slice.call(b.querySelectorAll('link[rel="import"]')),d=c.map(function(a){return a.href});this.depsStorage.setDeps(a,d),d.forEach(function(a){this.load(a)},this)},loadDeps:function(a){var b=this.depsStorage.getDeps(a);b.forEach(function(a){this.load(a)},this)}},function(){function a(a){a.triggers.forEach(function(c){b(c,a)})}function b(a,b){var c={proximity:n,focus:k,click:i,mouseover:l,added:m}[a.type];c.addTrigger({el:b.el,selector:b.selector,src:b.src,tagName:a.tagName,distance:a.distance})}var d=new j(new c(localStorage)),i=new e("click",d),k=new e("focus",d),l=new e("mouseover",d),m=(new f(d),new h(d),new g(d)),n={addTrigger:function(a){var b=getNode(a.el),c=getComputedStyle(b);"visible"!==c.overflow||"static"===c.position?mouseMoveProximityTriggerHandler.addTrigger(a):nodeProximityTriggerHandler.addTrigger(a)}};window.nmouse={prepare:a,loader:d}}(),function(){document.registerElement("nmouse-rule",{prototype:d.mix(Object.create(HTMLElement.prototype),{attachedCallback:function(){var a=[].slice.call(this.querySelectorAll("nmouse-trigger")).map(function(a){return{type:a.getAttribute("type"),tagName:a.getAttribute("tagName"),distance:a.getAttribute("distance")}});nmouse.prepare({el:this.getAttribute("el"),selector:this.getAttribute("selector"),src:this.getAttribute("src"),triggers:a})}})})}()}({},function(){return this}());
//# sourceMappingURL=nmouse.js.map